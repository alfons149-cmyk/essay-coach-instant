<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EssayCoach – Cambridge Toolkit (PWA)</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#111111" />

  <style>
    :root { --b:#111; --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:var(--bg); color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: clamp(16px, 4vw, 24px); }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 3.6vw, 28px); }
    .sub { color: var(--muted); margin: 0 0 16px; font-size: clamp(13px, 2.8vw, 14px); }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab { padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer; font-size:14px; min-height:44px; }
    .tab.active { background: var(--b); color:#fff; border-color: var(--b); }

    .card { background: var(--card); border:1px solid var(--border); border-radius:14px; padding: clamp(12px, 3.2vw, 16px); margin-bottom:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 860px) { .cols { grid-template-columns: 1fr; } }

    textarea, select, button { font:inherit; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; min-height:44px; }
    textarea { width:100%; resize:vertical; }
    button { cursor:pointer; }
    button.primary { background: var(--b); color:#fff; border-color: var(--b); }

    .notes { margin-top:10px; background:#f3f4f6; padding:10px; border-radius:10px; border:1px solid var(--border); }
    .hint { color:var(--muted); font-size:12px; margin-top:6px; }
    ul, ol { margin-top:6px; padding-left:20px; }

    .chip { display:inline-block; padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; margin:6px 8px 0 0; cursor:pointer; font-size:14px; min-height:38px; }
    .chip:hover { background:#f3f4f6; }
    .alt-section h4 { margin:12px 0 6px; font-size:14px; color:#333; }

    .toggle { display:flex; align-items:center; gap:8px; margin-top:6px; font-size:14px; }

    /* Modal styles */
    .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:100; }
    .modal { display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:101; }
    .modal-card { background:#fff; border-radius:12px; max-width:720px; width:90%; max-height:90vh; overflow:auto; padding:16px; }
    .modal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .modal-actions button, .modal-actions select { margin-left:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EssayCoach – Cambridge Toolkit</h1>
    <p class="sub">Scaffolds • Corrector (B2/C1) • Formal tone • Alternatives • Band descriptors • PDF • PWA</p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" id="tab-scaffolds" onclick="showTab('scaffolds')">Scaffolds</button>
      <button class="tab" id="tab-corrector" onclick="showTab('corrector')">Corrector</button>
    </div>

    <!-- SCAFFOLDS TAB -->
    <section id="view-scaffolds">
      <div class="card">
        <div class="cols">
          <label>
            <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Level</div>
            <select id="scLevel" onchange="renderScaffold()">
              <option value="B2">B2 First</option>
              <option value="C1">C1 Advanced</option>
            </select>
          </label>

          <label>
            <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Task type</div>
            <select id="scType" onchange="renderScaffold()">
              <option value="essay">Essay</option>
              <option value="report">Report</option>
              <option value="review">Review</option>
              <option value="letter">Formal letter/email</option>
            </select>
          </label>
        </div>

        <div class="row" style="margin-top:12px">
          <button onclick="copyScaffold()">Copy scaffold</button>
          <button onclick="copyOpener()">Copy opener</button>
          <button onclick="exportScaffoldPDF()">Export scaffold as PDF</button>
          <button class="primary" onclick="openGuide()">Guide & Example</button>
          <button onclick="openDescriptors()">Band descriptors</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0">Recommended moves (4-part structure)</h3>
        <ol id="scMoves"></ol>

        <h3 style="margin:16px 0 6px">Useful opener (example)</h3>
        <div id="scOpener" class="notes"></div>

        <h3 style="margin:16px 0 6px">Tips</h3>
        <ul id="scTips"></ul>
      </div>
    </section>

    <!-- CORRECTOR TAB -->
    <section id="view-corrector" style="display:none">
      <div class="card">
        <label>
          <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Level</div>
          <select id="levelSelect">
            <option value="B2">B2 First</option>
            <option value="C1">C1/C2 Advanced</option>
          </select>
        </label>

        <label style="display:block; margin-top:10px">
          <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Input</div>
          <textarea id="inputText" rows="7" placeholder="Type or paste your text here..."></textarea>
        </label>

        <div class="row" style="margin-top:10px">
          <button class="primary" onclick="runCorrection()">Correct</button>
          <button onclick="downloadPDF()">Export PDF</button>
          <button onclick="clearAll()">Clear</button>
        </div>

        <label class="toggle">
          <input type="checkbox" id="formalToggle" checked />
          <span>Enforce formal tone (avoid slang/colloquialisms)</span>
        </label>

        <label class="toggle">
          <input type="checkbox" id="aiToggle" />
          <span>Use AI (ChatGPT) for deeper corrections</span>
        </label>
      </div>

      <div class="card">
        <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Corrected Output</div>
        <textarea id="outputText" rows="7" readonly></textarea>
        <div class="notes" id="notes"><b>Changes:</b><br><span class="hint">Corrections appear here after “Correct”.</span></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Vocabulary alternatives</h3>
        <div id="altList" class="hint">After correction, suggested upgrades appear here.</div>
      </div>
    </section>
  </div>

  <!-- Guide modal -->
  <div id="guideBackdrop" class="modal-backdrop" onclick="closeGuide()"></div>
  <div id="guideModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-head">
        <h3 id="guideTitle">Guide & Example</h3>
        <button onclick="closeGuide()">Close</button>
      </div>
      <div id="guideBody" class="modal-body">Loading…</div>
    </div>
  </div>

  <!-- Band Descriptors modal -->
  <div id="descBackdrop" class="modal-backdrop" onclick="closeDescriptors()"></div>
  <div id="descModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="descTitle">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-head">
        <h3 id="descTitle">Band descriptors</h3>
        <div class="modal-actions">
          <select id="descLevel" onchange="renderDescriptors()">
            <option value="B2">B2 First</option>
            <option value="C1">C1 Advanced</option>
          </select>
          <button onclick="copyDescriptors()">Copy</button>
          <button onclick="exportDescriptorsPDF()">Export PDF</button>
          <button onclick="closeDescriptors()">Close</button>
        </div>
      </div>
      <div class="modal-body" id="descBody"></div>
      <div class="hint" style="padding:0 10px 10px">Condensed summary of Cambridge scales: Content, Communicative Achievement, Organisation, Language.</div>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    /* ========= Configure AI Worker endpoint ========= */
    const AI_ENDPOINT = "https://essaycoach.alfons149.workers.dev";

    /* Simple tab toggle */
    function showTab(which) {
      document.getElementById('view-scaffolds').style.display = (which === 'scaffolds') ? '' : 'none';
      document.getElementById('view-corrector').style.display = (which === 'corrector') ? '' : 'none';
      document.getElementById('tab-scaffolds').classList.toggle('active', which === 'scaffolds');
      document.getElementById('tab-corrector').classList.toggle('active', which === 'corrector');
    }

    /* Dummy scaffold data (shortened here for brevity) */
    const SCAFFOLDS = {
      B2: { essay:{ moves:["Intro","Body1","Body2","Conclusion"], opener:"In recent years…", tips:["Use clear topic sentences."] } },
      C1: { essay:{ moves:["Intro","Body1","Body2","Conclusion"], opener:"While opinions differ…", tips:["Use a wide range of cohesive devices."] } }
    };
    function renderScaffold() {
      const lvl=document.getElementById('scLevel').value, typ=document.getElementById('scType').value;
      const d=SCAFFOLDS[lvl][typ]; document.getElementById('scMoves').innerHTML=d.moves.map(m=>`<li>${m}</li>`).join('');
      document.getElementById('scOpener').textContent=d.opener; document.getElementById('scTips').innerHTML=d.tips.map(t=>`<li>${t}</li>`).join('');
    }
    renderScaffold();

    /* ===== Descriptors (condensed Cambridge summary) ===== */
    const DESCRIPTORS = { ... /* as given earlier (B2 & C1 with 4 scales) */ };
    function renderDescriptors(){ /* as given earlier */ }
    function openDescriptors(){ document.getElementById('descBackdrop').style.display='block'; document.getElementById('descModal').style.display='flex'; renderDescriptors();}
    function closeDescriptors(){ document.getElementById('descBackdrop').style.display='none'; document.getElementById('descModal').style.display='none';}
    function copyDescriptors(){ /* copy to clipboard */ }
    function exportDescriptorsPDF(){ /* PDF export code */ }

    /* ========== Corrector with AI fallback (simplified for clarity) ========== */
    async function runCorrection(){
      const text=document.getElementById("inputText").value;
      const lvl=document.getElementById("levelSelect").value;
      const formal=document.getElementById("formalToggle").checked;
      const useAI=document.getElementById("aiToggle").checked;
      const outBox=document.getElementById("outputText"), notesBox=document.getElementById("notes");

      if(useAI && AI_ENDPOINT){
        try{
          const resp=await fetch(AI_ENDPOINT,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({text,level:lvl,formal})});
          const data=await resp.json();
          if(data && typeof data.corrected==="string"){
            outBox.value=data.corrected;
            notesBox.innerHTML="<b>Changes (AI):</b><br>"+(Array.isArray(data.notes)?data.notes.map(n=>"• "+n).join("<br>"):"(none)");
            return;
          }
        }catch(e){ console.error("AI fetch failed",e);}
      }
      // fallback
      outBox.value=text; notesBox.innerHTML="<b>Changes:</b><br>(local rules not expanded here)";
    }

    function clearAll(){ document.getElementById("inputText").value=""; document.getElementById("outputText").value=""; document.getElementById("notes").innerHTML="<b>Changes:</b><br><span class='hint'>Cleared.</span>";}
    function downloadPDF(){ /* your jsPDF export code */ }
  </script>
</body>
</html>
