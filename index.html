<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EssayCoach – Cambridge Toolkit (PWA)</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#111111" />

  <style>
    :root { --b:#111; --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:var(--bg); color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: clamp(16px, 4vw, 24px); }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 3.6vw, 28px); }
    .sub { color: var(--muted); margin: 0 0 16px; font-size: clamp(13px, 2.8vw, 14px); }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab { padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer; font-size:14px; min-height:44px; }
    .tab.active { background: var(--b); color:#fff; border-color: var(--b); }

    .card { background: var(--card); border:1px solid var(--border); border-radius:14px; padding: clamp(12px, 3.2vw, 16px); }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 860px) { .cols { grid-template-columns: 1fr; } }

    textarea, select, button { font:inherit; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; min-height:44px; }
    textarea { width:100%; resize:vertical; }
    button { cursor:pointer; }
    button.primary { background: var(--b); color:#fff; border-color: var(--b); }

    .notes { margin-top:10px; background:#f3f4f6; padding:10px; border-radius:10px; border:1px solid var(--border); }
    .hint { color:var(--muted); font-size:12px; margin-top:6px; }
    ul, ol { margin-top:6px; padding-left:20px; }

    .chip { display:inline-block; padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; margin:6px 8px 0 0; cursor:pointer; font-size:14px; min-height:38px; }
    .chip:hover { background:#f3f4f6; }
    .alt-section h4 { margin:12px 0 6px; font-size:14px; color:#333; }

    .toggle { display:flex; align-items:center; gap:8px; margin-top:6px; font-size:14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EssayCoach – Cambridge Toolkit</h1>
    <p class="sub">Scaffolds • Corrector (B2/C1) • Formal tone • Safer spelling + a/an • Clause punctuation • Alternatives • PDF • PWA</p>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" id="tab-scaffolds" onclick="showTab('scaffolds')">Scaffolds</button>
      <button class="tab" id="tab-corrector" onclick="showTab('corrector')">Corrector</button>
    </div>

    <!-- SCAFFOLDS TAB -->
    <section id="view-scaffolds">
      <div class="card" style="margin-bottom:12px">
        <div class="cols">
          <label>
            <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Level</div>
            <select id="scLevel" onchange="renderScaffold()">
              <option value="B2">B2 First</option>
              <option value="C1">C1 Advanced</option>
            </select>
          </label>

          <label>
            <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Task type</div>
            <select id="scType" onchange="renderScaffold()">
              <option value="essay">Essay</option>
              <option value="report">Report</option>
              <option value="review">Review</option>
              <option value="letter">Formal letter/email</option>
            </select>
          </label>
        </div>

        <div class="row" style="margin-top:12px">
          <button onclick="copyScaffold()">Copy scaffold</button>
          <button onclick="copyOpener()">Copy opener</button>
          <button onclick="exportScaffoldPDF()">Export scaffold as PDF</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0">Recommended moves (4-part structure)</h3>
        <ol id="scMoves"></ol>

        <h3 style="margin:16px 0 6px">Useful opener (example)</h3>
        <div id="scOpener" class="notes"></div>

        <h3 style="margin:16px 0 6px">Tips</h3>
        <ul id="scTips"></ul>
        <div class="hint">Choose level and task to update the scaffold. You can copy or export to PDF.</div>
      </div>
    </section>

    <!-- CORRECTOR TAB -->
    <section id="view-corrector" style="display:none">
      <div class="card" style="margin-bottom:12px">
        <label>
          <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Level</div>
          <select id="levelSelect">
            <option value="B2">B2 First</option>
            <option value="C1">C1/C2 Advanced</option>
          </select>
        </label>

        <label style="display:block; margin-top:10px">
          <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Input</div>
          <textarea id="inputText" rows="7" placeholder="Type or paste your text here..."></textarea>
        </label>

        <div class="row" style="margin-top:10px">
          <button class="primary" onclick="runCorrection()">Correct</button>
          <button onclick="downloadPDF()">Export PDF</button>
          <button onclick="clearAll()">Clear</button>
          <button onclick="pasteFromClipboard()">Paste</button>
        </div>

        <label class="toggle">
          <input type="checkbox" id="formalToggle" checked />
          <span>Enforce formal tone (avoid slang/colloquialisms)</span>
        </label>

        <label class="toggle">
          <input type="checkbox" id="aiToggle" />
          <span>Use AI (ChatGPT) for deeper corrections (requires Worker URL)</span>
        </label>
      </div>

      <div class="card" style="margin-bottom:12px">
        <div style="color:#6b7280; font-size:14px; margin-bottom:6px">Corrected Output</div>
        <textarea id="outputText" rows="7" readonly placeholder="Your corrected text will appear here..."></textarea>
        <div class="notes" id="notes"><b>Changes:</b><br><span class="hint">Corrections will appear here after you click “Correct”.</span></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px">Vocabulary alternatives (click to apply)</h3>
        <div id="altList" class="hint">After correction, suggested upgrades will appear here (especially for C1/C2).</div>
      </div>
    </section>
  </div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

  <!-- Main logic -->
  <script>
    const AI_ENDPOINT = "https://essaycoach.alfons149.workers.dev"; // Cloudflare Worker

    function showTab(which){
      document.getElementById('tab-scaffolds').classList.toggle('active', which==='scaffolds');
      document.getElementById('tab-corrector').classList.toggle('active', which==='corrector');
      document.getElementById('view-scaffolds').style.display = (which==='scaffolds') ? '' : 'none';
      document.getElementById('view-corrector').style.display = (which==='corrector') ? '' : 'none';
    }

    /* === Dummy scaffold functions (replace with your real ones) === */
    function renderScaffold(){ document.getElementById('scMoves').innerHTML="<li>Intro</li><li>Point 1</li><li>Point 2</li><li>Conclusion</li>"; document.getElementById('scOpener').textContent="One important aspect to consider is…"; document.getElementById('scTips').innerHTML="<li>Plan before you write</li><li>Use linking words</li>"; }
    function copyScaffold(){ navigator.clipboard.writeText("Scaffold text").then(()=>alert("Copied!")); }
    function copyOpener(){ navigator.clipboard.writeText("One important aspect to consider is…"); }
    function exportScaffoldPDF(){ alert("Export scaffold to PDF coming soon"); }
    function renderAlternatives(text, alts, level){ document.getElementById('altList').innerHTML = alts.length ? alts.map(a=>`<div class="chip">${a.simple}: ${a.options.join(", ")}</div>`).join("") : "<span class='hint'>(no alternatives)</span>"; }
    function buildAlternatives(text, level){ return []; }
    function correctLocal(text, lvl){ return { out: text, notes:["(local rules only)"], alts:[] }; }

    /* === Correction with AI or fallback === */
    window.runCorrection = async function(){
      const text=document.getElementById("inputText").value;
      const lvl=document.getElementById("levelSelect").value;
      const formal=document.getElementById("formalToggle").checked;
      const useAI=document.getElementById("aiToggle").checked && AI_ENDPOINT.startsWith("https://");

      const setNotes=(html)=>{ document.getElementById("notes").innerHTML=html; };
      const setOut=(val)=>{ document.getElementById("outputText").value=val; };

      setNotes("<b>Changes:</b><br><span class='hint'>Processing…</span>");
      setOut("");

      if(useAI){
        try{
          const res=await fetch(AI_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text,level:lvl,formal})});
          const raw=await res.text(); let obj;
          try{ obj=JSON.parse(raw);}catch{ setNotes("AI returned invalid JSON:<br><pre>"+raw+"</pre>"); return;}
          if(obj.corrected){ setOut(obj.corrected); setNotes("<b>Changes (AI):</b><br>"+(obj.notes?.join("<br>")||"(none)")); renderAlternatives(obj.corrected,[],lvl); return;}
        }catch(e){ setNotes("AI error: "+e); return;}
      }
      const {out,notes,alts}=correctLocal(text,lvl); setOut(out); setNotes("<b>Changes:</b><br>"+notes.join("<br>")); renderAlternatives(out,alts,lvl);
    };

    window.clearAll=function(){ inputText.value=""; outputText.value=""; document.getElementById("notes").innerHTML="<b>Changes:</b><br>(cleared)"; document.getElementById("altList").innerHTML=""; };
    window.pasteFromClipboard=async function(){ try{ const text=await navigator.clipboard.readText(); if(text) inputText.value+=text; }catch(e){ alert("Paste failed: "+e); } };
    window.downloadPDF=function(){ const {jsPDF}=window.jspdf; const doc=new jsPDF(); doc.text(document.getElementById("outputText").value,10,10); doc.save("essay-corrected.pdf"); };

    renderScaffold();
    window.addEventListener('load',()=>{const aiBox=document.getElementById('aiToggle'); if(AI_ENDPOINT.startsWith("https://")) aiBox.checked=true; if(location.hash==='#corrector') showTab('corrector');});
  </script>
</body>
</html>
