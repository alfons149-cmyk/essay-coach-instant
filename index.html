<!doctype html>
<html data-theme="coral">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EssayCoach – Cambridge Toolkit (Unified EN/ES)</title>
  <meta name="x-build" content="v2025-09-08-unified-coral-fix" />
  <link rel="icon" type="image/png" sizes="192x192" href="/essay-coach-instant/icon-192.png">
  <!-- Optional: swap to your original font if different -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/essay-coach-instant/css/style.css">
  window.EC_CONFIG = { API_BASE:'/api', REQUIRE_SUBSCRIPTION: false, SHOW_TRIAL:true, QUOTA_CAP:20, TRIAL_DAYS:2 };

</head>
<body>
  <header>
    <div class="headerbar">
      <div>
        <nav class="row" aria-label="Language switch">
          <a href="/essay-coach-instant/" data-i18n="nav.english">English</a> |
          <a href="/essay-coach-instant/es/" data-i18n="nav.spanish">Español</a>
        </nav>
        <h1 data-i18n="app.title">EssayCoach – Cambridge Toolkit</h1>
      </div>
      <div class="row" style="gap:8px">
        <span id="quotaPill" class="pill">0/20</span>
        <div id="accountMenu"></div>
      </div>
    </div>
    <!-- Trial expiry banner -->
    <div id="trialBanner" class="hidden" style="margin:8px 0;padding:10px 12px;border:1px solid #f59e0b;background:#fff7ed;color:#7c2d12;border-radius:10px">
      <strong data-i18n="trial.expiringSoon">Trial ending soon</strong>
      <span id="trialBannerMsg" style="margin-left:8px"></span>
    </div>
  </header>

  <main class="grid">
    <!-- PAYWALL -->
    <section id="paywall" class="card hidden center">
      <h2 data-i18n="paywall.title">Subscribe to use the corrector</h2>
      <p class="muted" data-i18n="paywall.desc">Unlimited corrections, PDF export, and analyzer.</p>
      <div class="row center" style="justify-content:center">
        <button id="btnGoPricing" class="btn-primary" data-i18n="paywall.seePlans">See plans</button>
        <button id="btnStartTrial" class="btn-ghost" data-i18n="paywall.startTrial">Start 2‑day trial</button>
      </div>
    </section>

    <!-- PRICING -->
    <section id="pricing" class="card hidden">
      <h2 data-i18n="pricing.title">Plans</h2>
      <ul>
        <li><strong data-i18n="pricing.monthly.name">Monthly</strong> — <span data-i18n="pricing.monthly.price">€10</span> <span class="muted" data-i18n="pricing.monthly.note">per month, auto‑renews until cancelled</span></li>
        <li><strong data-i18n="pricing.exam.name">Exam Pack (6 months)</strong> — <span data-i18n="pricing.exam.price">€50</span> <span class="muted" data-i18n="pricing.exam.note">one‑time, auto‑expires</span></li>
      </ul>
      <div class="row">
        <button id="btnChooseMonthly" class="btn-primary" data-i18n="pricing.chooseMonthly">Choose Monthly</button>
        <button id="btnChooseExam" class="btn-ghost" data-i18n="pricing.chooseExam">Choose Exam Pack</button>
      </div>
    </section>

    <!-- APP BODY -->
    <section id="appBody" class="grid">
      <section id="corrector" class="card">
        <h2 data-i18n="corrector.title">AI Essay Corrector</h2>
        <div class="toolbar">
          <button id="btnCorrect" class="btn-primary" data-i18n="buttons.correct">Correct</button>
          <button id="btnExportPDF" class="btn-ghost" data-i18n="buttons.exportPdf">Export PDF</button>
          <button id="btnClear" class="btn-ghost" data-i18n="buttons.clear">Clear</button>
          <button id="btnPaste" class="btn-ghost" data-i18n="buttons.paste">Paste</button>
          <button id="btnTimer" class="btn-ghost" data-i18n="buttons.startTimer">Start timer</button>
        </div>
        <div class="row">
          <label class="toggle"><input type="checkbox" id="tgFormal" checked> <span data-i18n="toggles.formalTone">Formal tone</span></label>
          <label class="toggle"><input type="checkbox" id="tgCoachNotes" checked> <span data-i18n="toggles.coachNotes">Coach notes</span></label>
          <label class="toggle"><input type="checkbox" id="tgRubric" checked> <span data-i18n="toggles.rubricPoints">Rubric points</span></label>
        </div>
        <textarea id="essayIn" placeholder="Paste your essay here…"></textarea>
        <div id="essayOut" class="preview" aria-live="polite"></div>
        <div class="hint" data-i18n="corrector.hint">The output mirrors Cambridge descriptors. Toggle options above to customise.</div>
      </section>

      <section id="sentences" class="card">
        <h2 data-i18n="sentences.title">Sentence-Type Analysis (simple / compound / complex / compound–complex)</h2>
        <div id="sentenceAnalysis" class="preview"></div>
        <div class="hint" data-i18n="sentences.hint">Hover a sentence to see why it was classified and any issues spotted.</div>
      </section>

      <section id="punct" class="card">
        <h2 data-i18n="punct.header">Core Punctuation Rules (Exam-Safe)</h2>
        <div class="toolbar">
          <button id="btnCopyRules" class="btn-ghost" data-i18n="buttons.copyRules">Copy rules</button>
          <button id="btnExportRules" class="btn-ghost" data-i18n="buttons.exportRules">Export rules as PDF</button>
        </div>
        <div id="punctList" class="preview"></div>
      </section>

      <section id="part2" class="card">
        <h2 data-i18n="part2.title">Part 2 quick rubric – genre checks</h2>
        <div id="part2Rubric" class="preview"></div>
      </section>
    </section>
  </main>

  <!-- Analyzer module -->
  <script src="/essay-coach-instant/js/ec_sentences.js"></script>
  <!-- Optional PDF -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script> -->

  <script>
  // ===== Config & session =====
  window.EC_CONFIG = { API_BASE:'/api', REQUIRE_SUBSCRIPTION:true, SHOW_TRIAL:true, QUOTA_CAP:20, TRIAL_DAYS:2 };
  window.SESSION = { status:'inactive', email:null, token:null, trialStart:null, trialEnd:null };
  window.QUOTA = { used:0, cap:window.EC_CONFIG.QUOTA_CAP };

  // Robust locale detection: matches "/es" and "/es/"
  const path = location.pathname.toLowerCase();
  const LOCALE = /\/es(\/|$)/.test(path) ? 'es' : 'en';
  document.documentElement.lang = LOCALE;

  // Restore trial session & auto-expire
  try{
    const raw = localStorage.getItem('ec_session');
    if(raw){ const s = JSON.parse(raw); if(s && typeof s==='object') window.SESSION = { ...window.SESSION, ...s }; }
    if(window.SESSION.status==='trial' && window.SESSION.trialEnd && Date.now()>Number(window.SESSION.trialEnd)){
      window.SESSION = { status:'inactive', email:null, token:null, trialStart:null, trialEnd:null };
      localStorage.removeItem('ec_session');
    }
  }catch(_){}

  // ===== i18n (minimal loader) =====
  const BASE_APP = '/essay-coach-instant';

async function loadDict(lang){
  const url = `${BASE_APP}/i18n/${lang}.json?v=${Date.now()}`;
  try{
    const r = await fetch(url, { cache: 'no-store' });
    return r.ok ? r.json() : {};
  }catch{
    return {};
  }
}



  function applyI18n(dict){
    window._i18nDict = dict||{};
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key=el.getAttribute('data-i18n');
      const val=key.split('.').reduce((o,k)=>o&&o[k], dict);
      if(typeof val==='string') el.textContent = val;
    });
  }

  function t(path, fallback){
    try{
      const d = window._i18nDict || {};
      const v = path.split('.').reduce((o,k)=>o && o[k], d);
      return (typeof v === 'string' && v) ? v : (fallback || path);
    }catch(e){ return fallback || path; }
  }


  // ===== Helpers =====
  const $ = s=>document.querySelector(s);
  function escapeHtml(s){return (s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]))}
  function canUseCorrector(){ return window.SESSION.status==='active' || window.SESSION.status==='trial'; }

  function refreshGates(){
    const paywall = document.getElementById('paywall');
    if(!window.EC_CONFIG.REQUIRE_SUBSCRIPTION || canUseCorrector()) paywall.classList.add('hidden');
    else paywall.classList.remove('hidden');
    renderAccountMenu();
  }
  function renderAccountMenu(){
  const el = document.getElementById('accountMenu'); if(!el) return;
  const s = window.SESSION.status;
  const acct = escapeHtml(window.SESSION.email || t('account.account','Account'));
  if(s==='active'){
    el.innerHTML = `<span class="pill">${acct}</span>
      <button id="btnManagePlan" class="btn-ghost">${t('account.manage','Manage plan')}</button>
      <button id="btnSignOut" class="btn-ghost">${t('account.signOut','Sign out')}</button>`;
  } else if(s==='trial'){
    el.innerHTML = `<span class="pill">${t('account.trialActive','Trial active')}</span>
      <button id="btnSubscribe" class="btn-primary">${t('account.subscribe','Subscribe')}</button>
      <button id="btnSignOut" class="btn-ghost">${t('account.signOut','Sign out')}</button>`;
  } else {
    el.innerHTML = `<button id="btnLogin" class="btn-primary">${t('account.login','Log in')}</button>
      <button id="btnSignUp" class="btn-ghost">${t('account.signUp','Sign up')}</button>`;
  }
}


  // Trial countdown + banner
  function msLeftTrial(){ return (window.SESSION.status==='trial' && window.SESSION.trialEnd) ? Math.max(0, Number(window.SESSION.trialEnd)-Date.now()) : null; }
  function showQuota(){
    const qp=document.getElementById('quotaPill'); if(!qp) return;
    const ms = msLeftTrial();
    if(ms!==null){
      const day=24*60*60*1000;
      if(ms<day){ const h=Math.ceil(ms/(60*60*1000)); qp.textContent=`${LOCALE==='es'?'Prueba':'Trial'}: ${h} ${LOCALE==='es'?(h===1?'hora':'horas'):(h===1?'hour':'hours')} left`; }
      else { const d=Math.ceil(ms/day); qp.textContent=`${LOCALE==='es'?'Prueba':'Trial'}: ${d} ${LOCALE==='es'?(d===1?'día':'días'):(d===1?'day':'days')} left`; }
      return;
    }
    qp.textContent = `${window.QUOTA.used}/${window.QUOTA.cap}`;
  }
  function updateTrialBanner(){
    const box=document.getElementById('trialBanner'); const msg=document.getElementById('trialBannerMsg'); if(!box||!msg) return;
    const ms=msLeftTrial(); const day=24*60*60*1000;
    if(ms!==null && ms>0 && ms<=day){
      const h=Math.ceil(ms/(60*60*1000)); const unit=LOCALE==='es'?(h===1?'hora':'horas'):(h===1?'hour':'hours');
      msg.textContent = (LOCALE==='es') ? `Tu prueba termina en ${h} ${unit}.` : `Your trial ends in ${h} ${unit}.`;
      box.classList.remove('hidden');
    } else { box.classList.add('hidden'); msg.textContent=''; }
  }

  // ===== Content =====
  const PUNCT_GUIDE = `Why should you learn about punctuation?\nMost native speakers don't use punctuation correctly themselves. So, what's the point of learning this? The answer is simple: this is Cambridge. Using punctuation correctly and effectively shows your level and adds value to your composition.\n— Full stop (.)\n— Comma (,)\n— Semicolon (;)\n— Colon (:)\n— Dash (—)\n— Apostrophe (’)`;

  // ===== Corrector (backend-only) =====
 <script>
// ===== Config & session =====
window.EC_CONFIG = { API_BASE:'/api', REQUIRE_SUBSCRIPTION:true, SHOW_TRIAL:true, QUOTA_CAP:20, TRIAL_DAYS:2 };
window.SESSION = { status:'inactive', email:null, token:null, trialStart:null, trialEnd:null };
window.QUOTA = { used:0, cap:window.EC_CONFIG.QUOTA_CAP };

// Locale detection
const path = location.pathname.toLowerCase();
const LOCALE = /\/es(\/|$)/.test(path) ? 'es' : 'en';
document.documentElement.lang = LOCALE;

// ===== Dev Mode flag =====
const DEV_MODE = new URLSearchParams(location.search).get('dev') === '1';
if (DEV_MODE) {
  console.warn('⚠️ Dev Mode enabled — subscription checks bypassed');
  window.SESSION.status = 'active'; // pretend subscribed
  const dev = document.createElement('div');
  dev.textContent = 'DEV MODE';
  dev.style.cssText = 'position:fixed;top:8px;right:8px;background:#111827;color:#fff;font:12px/1.2 system-ui;padding:6px 8px;border-radius:6px;opacity:.85;z-index:9999';
  document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(dev));
}

// Helpers
function escapeHtml(s){return (s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;","&gt;"}[m]))}

// ===== Gate check =====
function canUseCorrector(){
  return DEV_MODE || window.SESSION.status==='active' || window.SESSION.status==='trial';
}

// ===== Corrector =====
async function runCorrection(src){
  if(!canUseCorrector()) {
    throw new Error(LOCALE==='es'
      ? 'Necesitas una suscripción activa para usar el corrector.'
      : 'You need an active subscription to use the corrector.');
  }

  // --- DEV MOCK (no backend needed) ---
  if (DEV_MODE) {
    const original = src || '';
    const sampleFix = original
      .replace(/\bI think\b/gi, LOCALE==='es' ? 'Creo que' : 'In my view')
      .replace(/\bvery\b/gi, LOCALE==='es' ? 'bastante' : 'quite');

    const tips = LOCALE==='es'
      ? [
          'Usa conectores más variados (p. ej., moreover, however).',
          'Evita repetición de “very”; prefiere adjetivos más precisos.',
          'Comprueba comas antes de “which/that” y después de conectores iniciales.'
        ]
      : [
          'Use a wider range of linkers (e.g., moreover, however).',
          'Avoid repeating “very”; prefer more precise adjectives.',
          'Check commas before “which/that” and after initial discourse markers.'
        ];

    const mockHTML = `
      <div class="kpi">
        <span class="pill ok">${LOCALE==='es'?'Tono formal':'Formal tone'} ✓</span>
        <span class="pill">${LOCALE==='es'?'Cohesión':'Cohesion'} B2→C1</span>
        <span class="pill warn">${LOCALE==='es'?'Puntuación':'Punctuation'} ~</span>
      </div>
      <div class="notes" style="margin-top:10px">
        <strong>${LOCALE==='es'?'Sugerencias del coach':'Coach notes'}</strong>
        <ul style="margin:8px 0 0 16px">
          <li>${tips[0]}</li>
          <li>${tips[1]}</li>
          <li>${tips[2]}</li>
        </ul>
      </div>
      <h4 style="margin:14px 0 8px">${LOCALE==='es'?'Versión mejorada (simulada)':'Improved version (simulated)'}</h4>
      <div class="preview">${escapeHtml(sampleFix).replace(/\n/g,'<br>')}</div>
    `;
    return mockHTML;
  }

  // --- Normal API call when not in Dev Mode ---
  const opts = {
    formal: document.getElementById('tgFormal')?.checked !== false,
    coachNotes: document.getElementById('tgCoachNotes')?.checked !== false,
    rubric: document.getElementById('tgRubric')?.checked !== false,
    level: 'C1', type: 'essay', locale: LOCALE
  };
  const endpoint = (window.EC_CONFIG.API_BASE||'') + '/correct';
  const token = window.SESSION?.token;
  const res = await fetch(endpoint, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{}) },
    body: JSON.stringify({ text: src, options: opts })
  });
  if(!res.ok) throw new Error('Correction failed');
  const data = await res.json();
  return data.output || '';
}
</script>


  // ===== Analyzer hook =====
  function updateSentenceAnalysis(text){ const box=document.getElementById('sentenceAnalysis'); if(!box) return; box.innerHTML = EC_Sentences.analyzeToHTML(text||'', { locale: LOCALE }); }

  // ===== Events =====
  document.addEventListener('click', async (e)=>{
    if(e.target.id==='btnGoPricing'){ document.getElementById('pricing').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
    if(e.target.id==='btnStartTrial' && window.EC_CONFIG.SHOW_TRIAL){
      const days=Number(window.EC_CONFIG.TRIAL_DAYS||2); const now=Date.now();
      window.SESSION.status='trial'; window.SESSION.trialStart=new Date(now).toISOString(); window.SESSION.trialEnd=now+days*24*60*60*1000;
      try{ localStorage.setItem('ec_session', JSON.stringify(window.SESSION)); }catch(_){ }
      refreshGates(); showQuota(); updateTrialBanner();
    }
    if(e.target.id==='btnCopyRules'){ try{ await navigator.clipboard.writeText(document.getElementById('punctList').innerText); }catch(_){}}
    if(e.target.id==='btnExportRules'){ alert('PDF export: enable jsPDF include to use'); }
    if(e.target.id==='btnClear'){ document.getElementById('essayIn').value=''; document.getElementById('essayOut').innerHTML=''; updateSentenceAnalysis(''); }
    if(e.target.id==='btnPaste'){ try{ const t=await navigator.clipboard.readText(); document.getElementById('essayIn').value=t; }catch(_){}}
    if(e.target.id==='btnCorrect'){
      const src=(document.getElementById('essayIn').value||'').trim();
      if(!src){ document.getElementById('essayOut').innerHTML=''; updateSentenceAnalysis(''); return; }
      document.getElementById('essayOut').innerHTML = LOCALE==='es' ? 'Procesando…' : 'Processing…';
      try{ const html = await runCorrection(src); document.getElementById('essayOut').innerHTML = html; updateSentenceAnalysis(src); window.QUOTA.used=Math.min(window.QUOTA.used+1, window.QUOTA.cap); showQuota(); }
      catch(err){ document.getElementById('essayOut').innerHTML = `<div class="hint">${escapeHtml(err.message)}</div>`; }
    }

    // Account menu placeholders
    if(e.target.id==='btnLogin') alert('Login coming soon');
    if(e.target.id==='btnSignUp') alert('Sign up coming soon');
    if(e.target.id==='btnSubscribe'){ document.getElementById('pricing').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
    if(e.target.id==='btnManagePlan') alert('Manage portal coming soon');
    if(e.target.id==='btnSignOut'){ window.SESSION={ status:'inactive', email:null, token:null, trialStart:null, trialEnd:null }; try{ localStorage.removeItem('ec_session'); }catch(_){ } refreshGates(); showQuota(); updateTrialBanner(); }
  });

  document.addEventListener('input', (e)=>{ if(e.target && e.target.id==='essayIn') updateSentenceAnalysis(e.target.value); });

  // ===== Init =====
async function init(){
  const dict = await loadDict(LOCALE);
  try { 
    applyI18n(dict); 
  } catch(e){ 
    console.warn('i18n apply failed', e); 
  }
console.log('LOCALE detected =', LOCALE, 'path =', location.pathname);
console.log('Loaded dict keys:', Object.keys(window._i18nDict||{}));

  // Punctuation guide: prefer ES/EN json, fallback to English constant
  const pg = document.getElementById('punctList');
if (pg) {
  pg.textContent =
    (window._i18nDict && window._i18nDict.punct && window._i18nDict.punct.guide)
      ? window._i18nDict.punct.guide
      : PUNCT_GUIDE;
}


  refreshGates();
  showQuota();
  updateTrialBanner();
}
init();


  setInterval(()=>{ showQuota(); updateTrialBanner(); }, 10*60*1000);
  </script>
</body>
</html>
