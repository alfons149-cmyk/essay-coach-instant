<!doctype html>
<html data-theme="coral">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EssayCoach – Cambridge Toolkit (Unified EN/ES)</title>
  <meta name="x-build" content="v2025-09-15-unified-coral-full-punctfix" />
  <link rel="icon" type="image/png" sizes="192x192" href="/essay-coach-instant/icon-192.png">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:wght@400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/essay-coach-instant/css/style.css">

  <style>
    /* Textbox: readable serif */
    #essayIn {
      font-family: "IBM Plex Serif", Georgia, "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.7;
      padding: 12px 14px;
      letter-spacing: 0.005em;
    }

    /* Preview: make paragraphs breathe */
    #essayOut.preview { white-space: pre-line; line-height: 1.6; }
    #essayOut.preview p { margin: 0 0 0.9em; }
    #essayOut.preview p:last-child { margin-bottom: 0; }

    /* Punctuation guide spacing */
    #punctList { line-height: 1.6; }
    #punctList p { margin: 0 0 0.8em; }
    #punctList ul { margin: 0.5em 0 0.5em 1.2em; padding: 0; list-style: disc; }
    #punctList li { margin: 0.3em 0; }

    /* --- Rubric / KPI tiles --- */
.kpi { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 10px; }
.tile { border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; min-width:160px; flex:0 0 auto; }
.tile h4 { margin:0 0 6px; font-size:14px; font-weight:600; }
.score { font-weight:700; }
.badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; }
.badge.ok { background:#ecfdf5; border-color:#34d399; }
.badge.warn { background:#fff7ed; border-color:#f59e0b; }
.badge.err { background:#fef2f2; border-color:#ef4444; }

/* --- Lists / issues --- */
.list { margin:6px 0 0 18px; }
.issue { border-left:3px solid #f59e0b; padding:6px 10px; margin:8px 0; background:#fffaf0; border-radius:6px; }
.issue.major { border-color:#ef4444; background:#fef2f2; }
.issue .cat { font-weight:600; }

/* --- Checklist --- */
.checklist { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0; }
.check { border:1px dashed #e5e7eb; border-radius:999px; padding:4px 10px; font-size:12px; }
.check.ok { border-style:solid; background:#ecfeff; border-color:#06b6d4; }

  </style>
</head>
<body>
  <header>
    <div class="headerbar">
      <div>
        <nav class="row" aria-label="Language switch">
          <a href="/essay-coach-instant/" data-i18n="nav.english">English</a> |
          <a href="/essay-coach-instant/es/" data-i18n="nav.spanish">Español</a>
        </nav>
        <h1 data-i18n="app.title">EssayCoach – Cambridge Toolkit</h1>
      </div>
      <div class="row" style="gap:8px">
        <span id="quotaPill" class="pill">0/20</span>
        <div id="accountMenu"></div>
      </div>
    </div>
    <!-- Trial expiry banner -->
    <div id="trialBanner" class="hidden" style="margin:8px 0;padding:10px 12px;border:1px solid #f59e0b;background:#fff7ed;color:#7c2d12;border-radius:10px">
      <strong data-i18n="trial.expiringSoon">Trial ending soon</strong>
      <span id="trialBannerMsg" style="margin-left:8px"></span>
    </div>
  </header>

  <main class="grid">
    <!-- PAYWALL -->
    <section id="paywall" class="card hidden center">
      <h2 data-i18n="paywall.title">Subscribe to use the corrector</h2>
      <p class="muted" data-i18n="paywall.desc">Unlimited corrections, PDF export, and analyzer.</p>
      <div class="row center" style="justify-content:center">
        <button id="btnGoPricing" class="btn-primary" data-i18n="paywall.seePlans">See plans</button>
        <button id="btnStartTrial" class="btn-ghost" data-i18n="paywall.startTrial">Start 2-day trial</button>
      </div>
    </section>

    <!-- PRICING -->
    <section id="pricing" class="card hidden">
      <h2 data-i18n="pricing.title">Plans</h2>
      <ul>
        <li><strong data-i18n="pricing.monthly.name">Monthly</strong> — <span data-i18n="pricing.monthly.price">€15</span> <span class="muted" data-i18n="pricing.monthly.note">per month, auto-renews until cancelled</span></li>
        <li><strong data-i18n="pricing.exam.name">Exam Pack (6 months)</strong> — <span data-i18n="pricing.exam.price">€75</span> <span class="muted" data-i18n="pricing.exam.note">one-time, auto-expires</span></li>
      </ul>
      <div class="row">
        <button id="btnChooseMonthly" class="btn-primary" data-i18n="pricing.chooseMonthly">Choose Monthly</button>
        <button id="btnChooseExam" class="btn-ghost" data-i18n="pricing.chooseExam">Choose Exam Pack</button>
      </div>
    </section>

    <!-- APP BODY -->
    <section id="appBody" class="grid">
      <section id="corrector" class="card">
        <h2 data-i18n="corrector.title">AI Essay Corrector</h2>
        <div class="toolbar">
          <button id="btnCorrect" class="btn-primary" data-i18n="buttons.correct">Correct</button>
          <button id="btnExportPDF" class="btn-ghost" data-i18n="buttons.exportPdf">Export PDF</button>
          <button id="btnClear" class="btn-ghost" data-i18n="buttons.clear">Clear</button>
          <button id="btnPaste" class="btn-ghost" data-i18n="buttons.paste">Paste</button>
          <button id="btnTimer" class="btn-ghost" data-i18n="buttons.startTimer">Start timer</button>
        </div>
        <div class="row">
          <label class="toggle"><input type="checkbox" id="tgFormal" checked> <span data-i18n="toggles.formalTone">Formal tone</span></label>
          <label class="toggle"><input type="checkbox" id="tgCoachNotes" checked> <span data-i18n="toggles.coachNotes">Coach notes</span></label>
          <label class="toggle"><input type="checkbox" id="tgRubric" checked> <span data-i18n="toggles.rubricPoints">Rubric points</span></label>
        </div>

        <!-- NEW: Level & Task type selectors (minimal addition) -->
        <div class="row">
          <label class="toggle">
            <span style="margin-right:6px">Level</span>
            <select id="levelSelect">
              <option value="B2">B2 (First)</option>
              <option value="C1" selected>C1 (Advanced)</option>
              <option value="C2">C2 (Proficiency)</option>
            </select>
          </label>
          <label class="toggle" style="margin-left:12px">
            <span style="margin-right:6px">Task type</span>
            <select id="typeSelect">
              <option value="essay" selected>Essay (Part 1)</option>
              <option value="report">Report</option>
              <option value="proposal">Proposal</option>
              <option value="review">Review</option>
              <option value="letter">Letter/Email</option>
            </select>
          </label>
        </div>

        <textarea id="essayIn" placeholder="Paste your essay here…"></textarea>
        <div id="essayOut" class="preview" aria-live="polite"></div>
        <div class="hint" data-i18n="corrector.hint">The output mirrors Cambridge descriptors. Toggle options above to customise.</div>
      </section>

      <section id="sentences" class="card">
        <h2 data-i18n="sentences.title">Sentence-Type Analysis (simple / compound / complex / compound–complex)</h2>
        <div id="sentenceAnalysis" class="preview"></div>
        <div class="hint" data-i18n="sentences.hint">Hover a sentence to see why it was classified and any issues spotted.</div>
      </section>

      <section id="punct" class="card">
        <h2 data-i18n="punct.header">Core Punctuation Rules (Exam-Safe)</h2>
        <div class="toolbar">
          <button id="btnCopyRules" class="btn-ghost" data-i18n="buttons.copyRules">Copy rules</button>
          <button id="btnExportRules" class="btn-ghost" data-i18n="buttons.exportRules">Export rules as PDF</button>
        </div>
        <div id="punctList" class="preview"></div>
      </section>

      <section id="part2" class="card">
        <h2 data-i18n="part2.title">Part 2 quick rubric – genre checks</h2>
        <div id="part2Rubric" class="preview"></div>
      </section>
    </section>
  </main>

  <!-- Analyzer module -->
  <script src="/essay-coach-instant/js/ec_sentences.js"></script>
  <!-- Optional PDF -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script> -->

  <script>
    // ===== Config & session =====
    window.EC_CONFIG = { API_BASE:'/api', REQUIRE_SUBSCRIPTION:true, SHOW_TRIAL:true, QUOTA_CAP:20, TRIAL_DAYS:2 };
    window.SESSION = { status:'inactive', email:null, token:null, trialStart:null, trialEnd:null };
    window.QUOTA = { used:0, cap:window.EC_CONFIG.QUOTA_CAP };

    // Locale detection
    const path = location.pathname.toLowerCase();
    const LOCALE = /\/es(\/|$)/.test(path) ? 'es' : 'en';
    document.documentElement.lang = LOCALE;

    // Restore trial session & auto-expire
    try{
      const raw = localStorage.getItem('ec_session');
      if(raw){ const s = JSON.parse(raw); if(s && typeof s==='object') window.SESSION = { ...window.SESSION, ...s }; }
      if(window.SESSION.status==='trial' && window.SESSION.trialEnd && Date.now()>Number(window.SESSION.trialEnd)){
        window.SESSION = { status:'inactive', email:null, token:null, trialStart:null, trialEnd:null };
        localStorage.removeItem('ec_session');
      }
    }catch(_){}

    // ===== i18n (minimal loader) =====
    const BASE_APP = '/essay-coach-instant';
    async function loadDict(lang){
      const url = `${BASE_APP}/i18n/${lang}.json?v=${Date.now()}`;
      try{
        const r = await fetch(url, { cache: 'no-store' });
        return r.ok ? r.json() : {};
      }catch{
        return {};
      }
    }
    function applyI18n(dict){
      window._i18nDict = dict||{};
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key=el.getAttribute('data-i18n');
        const val=key.split('.').reduce((o,k)=>o&&o[k], dict);
        if(typeof val==='string') el.textContent = val;
      });
    }
    function t(path, fallback){
      try{
        const d = window._i18nDict || {};
        const v = path.split('.').reduce((o,k)=>o && o[k], d);
        return (typeof v === 'string' && v) ? v : (fallback || path);
      }catch(e){ return fallback || path; }
    }

    // ===== Helpers =====
    const $ = s=>document.querySelector(s);
    function escapeHtml(s){return (s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]))}
    const DEV_MODE = new URLSearchParams(location.search).get('dev') === '1';
    function canUseCorrector(){ return DEV_MODE || window.SESSION.status==='active' || window.SESSION.status==='trial'; }

    <script>
// ========== Rendering helpers ==========
function stripTags(html=""){ const d=document.createElement('div'); d.innerHTML=html; return d.textContent || d.innerText || ''; }
function num(v, d=0){ return typeof v==='number' ? v : d; }
function el(tag, attrs={}, html){
  const n=document.createElement(tag);
  Object.entries(attrs||{}).forEach(([k,v])=>{ if(k==='class') n.className=v; else n.setAttribute(k,v); });
  if(html!==undefined) n.innerHTML = html;
  return n;
}
function wcOf(text){ return (stripTags(text).match(/\b[\w’'-]+\b/g)||[]).length; }

function wordBand(level){
  if(level==='B2') return {min:140, max:190};
  if(level==='C2') return {min:240, max:280};       // CPE Part 1 guidance
  return {min:220, max:260};                         // C1
}

function bandBadge(ok){ return ok ? 'badge ok' : 'badge warn'; }
function sevClass(sev){ return sev==='major' ? 'issue major' : 'issue'; }
</script>

    // ===== Account UI =====
    function renderAccountMenu(){
      const el = document.getElementById('accountMenu'); if(!el) return;
      const s = window.SESSION.status;
      const acct = escapeHtml(window.SESSION.email || t('account.account','Account'));
      if(s==='active'){
        el.innerHTML = `<span class="pill">${acct}</span>
          <button id="btnManagePlan" class="btn-ghost">${t('account.manage','Manage plan')}</button>
          <button id="btnSignOut" class="btn-ghost">${t('account.signOut','Sign out')}</button>`;
      } else if(s==='trial'){
        el.innerHTML = `<span class="pill">${t('account.trialActive','Trial active')}</span>
          <button id="btnSubscribe" class="btn-primary">${t('account.subscribe','Subscribe')}</button>
          <button id="btnSignOut" class="btn-ghost">${t('account.signOut','Sign out')}</button>`;
      } else {
        el.innerHTML = `<button id="btnLogin" class="btn-primary">${t('account.login','Log in')}</button>
          <button id="btnSignUp" class="btn-ghost">${t('account.signUp','Sign up')}</button>`;
      }
    }
    function refreshGates(){
      const paywall = document.getElementById('paywall');
      if(!window.EC_CONFIG.REQUIRE_SUBSCRIPTION || canUseCorrector()) paywall.classList.add('hidden');
      else paywall.classList.remove('hidden');
      renderAccountMenu();
    }

    // Trial countdown + banner
    function msLeftTrial(){ return (window.SESSION.status==='trial' && window.SESSION.trialEnd) ? Math.max(0, Number(window.SESSION.trialEnd)-Date.now()) : null; }
    function showQuota(){
      const qp=document.getElementById('quotaPill'); if(!qp) return;
      const ms = msLeftTrial();
      if(ms!==null){
        const day=24*60*60*1000;
        if(ms<day){ const h=Math.ceil(ms/(60*60*1000)); qp.textContent=`${LOCALE==='es'?'Prueba':'Trial'}: ${h} ${LOCALE==='es'?(h===1?'hora':'horas'):(h===1?'hour':'hours')} left`; }
        else { const d=Math.ceil(ms/day); qp.textContent=`${LOCALE==='es'?'Prueba':'Trial'}: ${d} ${LOCALE==='es'?(d===1?'día':'días'):(d===1?'day':'days')} left`; }
        return;
      }
      qp.textContent = `${window.QUOTA.used}/${window.QUOTA.cap}`;
    }
    function updateTrialBanner(){
      const box=document.getElementById('trialBanner'); const msg=document.getElementById('trialBannerMsg'); if(!box||!msg) return;
      const ms=msLeftTrial(); const day=24*60*60*1000;
      if(ms!==null && ms>0 && ms<=day){
        const h=Math.ceil(ms/(60*60*1000)); const unit=LOCALE==='es'?(h===1?'hora':'horas'):(h===1?'hour':'hours');
        msg.textContent = (LOCALE==='es') ? `Tu prueba termina en ${h} ${unit}.` : `Your trial ends in ${h} ${unit}.`;
        box.classList.remove('hidden');
      } else { box.classList.add('hidden'); msg.textContent=''; }
    }

    // ===== Content (HTML fallback for punctuation guide) =====
    const PUNCT_GUIDE = "<p><strong>Why should you learn about punctuation?</strong><br> Most native speakers don't use punctuation correctly themselves. So, what's the point of learning this? The answer is simple: this is Cambridge. Using punctuation correctly and effectively shows your level and adds value to your composition.</p><ul><li><strong>Full stop (.)</strong> — Use at the end of sentences.</li><li><strong>Comma (,)</strong> — Separate items in a list, clauses, or after connectors.</li><li><strong>Semicolon (;)</strong> — Link closely related independent clauses.</li><li><strong>Colon (:)</strong> — Introduce a list, explanation, or example.</li><li><strong>Dash (—)</strong> — Add emphasis or mark off extra information.</li><li><strong>Apostrophe (’)</strong> — Show possession or form contractions.</li></ul>";

    function renderPunctGuide(){
      const pg=document.getElementById('punctList'); if(!pg) return;
      let html=(window._i18nDict&&window._i18nDict.punct&&window._i18nDict.punct.guide)
        ? window._i18nDict.punct.guide : PUNCT_GUIDE;
      // Decode if JSON contains &lt;…&gt; entities
      if(/&lt;|&gt;|&amp;/.test(html)){ const ta=document.createElement('textarea'); ta.innerHTML=html; html=ta.value; }
      pg.innerHTML=html;
    }

   // ===== DEV MODE banner / bypass =====
if (DEV_MODE) {
  console.warn('⚠️ Dev Mode enabled — subscription checks bypassed');
  window.SESSION.status = 'active';
  const dev = document.createElement('div');
  dev.textContent = 'DEV MODE';
  dev.style.cssText = 'position:fixed;top:8px;right:8px;background:#111827;color:#fff;font:12px/1.2 system-ui;padding:6px 8px;border-radius:6px;opacity:.85;z-index:9999';
  document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(dev));
}


     // ===== Corrector =====
   <script>
async function runCorrection(src){
  if(!canUseCorrector()) {
    throw new Error(LOCALE==='es'
      ? 'Necesitas una suscripción activa para usar el corrector.'
      : 'You need an active subscription to use the corrector.');
  }

  const opts = {
    formal: document.getElementById('tgFormal')?.checked !== false,
    coachNotes: document.getElementById('tgCoachNotes')?.checked !== false,
    rubric: document.getElementById('tgRubric')?.checked !== false,
    level: (document.getElementById('levelSelect')?.value || 'C1'),
    type:  (document.getElementById('typeSelect')?.value  || 'essay'),
    locale: LOCALE
  };

  // --- DEV MOCK: return structured JSON so UI behaves like production ---
  if (DEV_MODE) {
    const improved = (LOCALE==='es'
      ? `<p>En mi opinión, las ciudades deberían invertir más en transporte público; además, reduciría la congestión y mejoraría la calidad del aire.</p><p>No obstante, es esencial evaluar el coste a largo plazo y la sostenibilidad del sistema.</p>`
      : `<p>In my view, cities should invest more in public transport; moreover, it would reduce congestion and improve air quality.</p><p>However, it is essential to evaluate long-term costs and the sustainability of the system.</p>`);

    const level = opts.level;
    const {min,max} = wordBand(level);
    const textWC = wcOf(improved);

    return {
      improved_text: improved,
      rubric: {
        content: { score: level==='C2'?5: (level==='C1'?4:3), evidence: [ LOCALE==='es'?'Responde a la tarea y aporta ejemplos':'Addresses the task with relevant examples' ] },
        communicative_achievement: { score: level==='C2'?5:4, evidence: [ LOCALE==='es'?'Registro formal sostenido':'Sustained formal register' ] },
        organisation: { score: level==='C2'?5:4, evidence: [ LOCALE==='es'?'Párrafos y conectores claros':'Clear paragraphing and discourse markers' ] },
        language: { score: level==='C2'?5:4, evidence: [ LOCALE==='es'?'Buen rango con pocos errores':'Good range with few slips' ] }
      },
      checks: {
        word_count: { actual: textWC, target_min: min, target_max: max, ok: textWC>=min && textWC<=max },
        register: { level: 'formal', violations: [] },
        linkers: { range: ['moreover','however'], variety_ok: true },
        sentence_types: { simple: 1, compound: 1, complex: 2, compound_complex: 0 },
        cohesion: { issues: [] },
        c2_synthesis: (level==='C2'
          ? { required: true, summary_ok: true, evaluation_ok: true }
          : { required: false, summary_ok: null, evaluation_ok: null })
      },
      issues: [
        { span:[0,0], category:'lexis', severity:'minor', msg: LOCALE==='es'?'Podrías matizar con hedging':'Consider hedging for nuance', suggestion: LOCALE==='es'?'It seems / arguably':'It seems / arguably' }
      ],
      coach_notes: (LOCALE==='es'
        ? ['Añade una contraargumentación breve en el párrafo 2.', 'Sustituye intensificadores genéricos.']
        : ['Add a brief counter-argument in paragraph 2.', 'Replace generic intensifiers.'])
    };
  }

  // --- Production call ---
  const endpoint = (window.EC_CONFIG.API_BASE||'') + '/correct';
  const token = window.SESSION?.token;
  const res = await fetch(endpoint, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{}) },
    body: JSON.stringify({ text: src, options: opts })
  });
  if(!res.ok) throw new Error('Correction failed');
  const data = await res.json();

  // Backward compatibility: if backend still returns a string html
  if (typeof data === 'string' || typeof data.output === 'string') {
    return {
      improved_text: data.output || data,
      rubric: null,
      checks: null,
      issues: [],
      coach_notes: []
    };
  }
  return data;
}
</script>

          <script>
function renderCorrection(data, level){
  const out = document.getElementById('essayOut');
  const { improved_text, rubric, checks, issues, coach_notes } = data || {};
  const { min, max } = wordBand(level);

  // KPI row (wordcount + quick badges)
  const wcActual = (checks?.word_count?.actual) ?? wcOf(improved_text || '');
  const wcOk = (checks?.word_count?.ok) ?? (wcActual>=min && wcActual<=max);
  const wcBadge = `<span class="${bandBadge(wcOk)}">Words: ${wcActual} (${min}–${max}${wcOk?' ✓': (wcActual<min?' ↓':' ↑')})</span>`;

  const synth = checks?.c2_synthesis;
  const synthBadge = (synth?.required)
    ? `<span class="${(synth.summary_ok && synth.evaluation_ok)?'badge ok':'badge warn'}">C2 synthesis</span>`
    : '';

  const regViol = (checks?.register?.violations||[]);
  const regBadge = `<span class="${regViol.length? 'badge warn':'badge ok'}">${LOCALE==='es'?'Registro':'Register'}${regViol.length? ' ⚠︎':''}</span>`;

  const kpi = `<div class="kpi">${wcBadge} ${regBadge} ${synthBadge}</div>`;

  // Rubric tiles
  let rubricHTML = '';
  if (rubric) {
    const keys = [
      ['content', LOCALE==='es'?'Contenido':'Content'],
      ['communicative_achievement', LOCALE==='es'?'Logro comunicativo':'Communicative achievement'],
      ['organisation', LOCALE==='es'?'Organización':'Organisation'],
      ['language', LOCALE==='es'?'Lengua':'Language']
    ];
    rubricHTML = `<div class="kpi" style="margin-top:6px"></div><div class="tiles" style="display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 10px">` +
      keys.map(([k,label])=>{
        const r = rubric[k] || {};
        const score = num(r.score, 0);
        const ev = (r.evidence||[]).slice(0,2).map(e=>`<li>${escapeHtml(e)}</li>`).join('');
        return `<div class="tile">
                  <h4>${escapeHtml(label)}</h4>
                  <div><span class="score">${score}/5</span></div>
                  ${ev?`<ul class="list">${ev}</ul>`:''}
                </div>`;
      }).join('') + `</div>`;
  }

  // C2 checklist (only if required)
  let c2List = '';
  if (synth?.required) {
    const items = [
      [synth.summary_ok, LOCALE==='es'?'Resumen integrado de ambas fuentes':'Integrated summary of both sources'],
      [synth.evaluation_ok, LOCALE==='es'?'Evaluación/juicio crítico':'Evaluation / critical stance']
    ];
    c2List = `<div><div style="font-weight:600;margin-top:6px">${LOCALE==='es'?'Síntesis C2':'C2 Synthesis'}</div>
      <div class="checklist">` + items.map(([ok,label])=>`<span class="check ${ok?'ok':''}">${escapeHtml(label)}</span>`).join('') + `</div></div>`;
  }

  // Register violations list (if any)
  const regList = regViol.length
    ? `<div style="margin-top:8px">
         <div style="font-weight:600">${LOCALE==='es'?'Registro: posibles problemas':'Register: possible issues'}</div>
         <ul class="list">${regViol.map(v=>`<li>${escapeHtml(v)}</li>`).join('')}</ul>
       </div>`
    : '';

  // Issues
  const issuesHTML = (issues||[]).length
    ? `<div style="margin-top:10px">
         <div style="font-weight:600">${LOCALE==='es'?'Observaciones':'Issues'}</div>
         ${(issues||[]).map(it=>`<div class="${sevClass(it.severity)}">
            <div class="cat">${escapeHtml(it.category||'')}</div>
            <div>${escapeHtml(it.msg||'')}</div>
            ${it.suggestion? `<div><em>${LOCALE==='es'?'Sugerencia:':'Suggestion:'}</em> ${escapeHtml(it.suggestion)}</div>`:''}
          </div>`).join('')}
       </div>`
    : '';

  // Coach notes
  const notes = (coach_notes||[]).length
    ? `<div class="notes" style="margin-top:10px">
         <strong>${LOCALE==='es'?'Sugerencias del coach':'Coach notes'}</strong>
         <ul class="list">${coach_notes.map(n=>`<li>${escapeHtml(n)}</li>`).join('')}</ul>
       </div>`
    : '';

  // Improved text (safe to set as HTML; your backend should sanitize; we also only allow basic markup)
  const improvedHTML = `<h4 style="margin:12px 0 6px">${LOCALE==='es'?'Versión mejorada':'Improved version'}</h4>
                        <div class="preview">${improved_text||''}</div>`;

  out.innerHTML = `${kpi}${rubricHTML}${c2List}${regList}${issuesHTML}${notes}${improvedHTML}`;

  // Update sentence analysis for the **corrected** text
  updateSentenceAnalysis(stripTags(improved_text||''));
}
</script>


      // Real API call — now uses selected level & type
      const opts = {
        formal: document.getElementById('tgFormal')?.checked !== false,
        coachNotes: document.getElementById('tgCoachNotes')?.checked !== false,
        rubric: document.getElementById('tgRubric')?.checked !== false,
        level: (document.getElementById('levelSelect')?.value || 'C1'),
        type:  (document.getElementById('typeSelect')?.value  || 'essay'),
        locale: LOCALE
      };
      const endpoint = (window.EC_CONFIG.API_BASE||'') + '/correct';
      const token = window.SESSION?.token;
      const res = await fetch(endpoint, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{}) },
        body: JSON.stringify({ text: src, options: opts })
      });
      if(!res.ok) throw new Error('Correction failed');
      const data = await res.json();
      return data.output || '';
    }

    // ===== Analyzer hook =====
    function updateSentenceAnalysis(text){
      const box=document.getElementById('sentenceAnalysis');
      if (!box) return;
      box.innerHTML = text ? (window.EC_Sentences?.analyzeToHTML(text, { locale: LOCALE }) || "") : "";
    }

    // ===== Events =====
    document.addEventListener('click', async (e)=>{
      if(e.target.id==='btnGoPricing'){ document.getElementById('pricing').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
      if(e.target.id==='btnStartTrial' && window.EC_CONFIG.SHOW_TRIAL){
        const days=Number(window.EC_CONFIG.TRIAL_DAYS||2); const now=Date.now();
        window.SESSION.status='trial'; window.SESSION.trialStart=new Date(now).toISOString(); window.SESSION.trialEnd=now+days*24*60*60*1000;
        try{ localStorage.setItem('ec_session', JSON.stringify(window.SESSION)); }catch(_){ }
        refreshGates(); showQuota(); updateTrialBanner();
      }
      if(e.target.id==='btnCopyRules'){ try{ await navigator.clipboard.writeText(document.getElementById('punctList').innerText); }catch(_){}}
      if(e.target.id==='btnExportRules'){ alert('PDF export: enable jsPDF include to use'); }
      if(e.target.id==='btnClear'){ document.getElementById('essayIn').value=''; document.getElementById('essayOut').innerHTML=''; updateSentenceAnalysis(''); }
      if(e.target.id==='btnPaste'){ try{ const t=await navigator.clipboard.readText(); document.getElementById('essayIn').value=t; }catch(_){}}
      if(e.target.id==='btnCorrect'){
        const src=(document.getElementById('essayIn').value||'').trim();
        if(!src){ document.getElementById('essayOut').innerHTML=''; updateSentenceAnalysis(''); return; }
        document.getElementById('essayOut').innerHTML = LOCALE==='es' ? 'Procesando…' : 'Processing…';
        try{
          const html = await runCorrection(src);
          document.getElementById('essayOut').innerHTML = html;
          updateSentenceAnalysis(src);
          window.QUOTA.used=Math.min(window.QUOTA.used+1, window.QUOTA.cap); showQuota();
        }
        catch(err){ document.getElementById('essayOut').innerHTML = `<div class="hint">${escapeHtml(err.message)}</div>`; }
      }

      // Account menu placeholders
      if(e.target.id==='btnLogin') alert('Login coming soon');
      if(e.target.id==='btnSignUp') alert('Sign up coming soon');
      if(e.target.id==='btnSubscribe'){ document.getElementById('pricing').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
      if(e.target.id==='btnManagePlan') alert('Manage portal coming soon');
      if(e.target.id==='btnSignOut'){
        window.SESSION={ status:'inactive', email:null, token:null, trialStart:null, trialEnd:null };
        try{ localStorage.removeItem('ec_session'); }catch(_){ }
        refreshGates(); showQuota(); updateTrialBanner();
      }
    });

    document.addEventListener('input', (e)=>{ if(e.target && e.target.id==='essayIn') updateSentenceAnalysis(e.target.value); });

    // ===== Init =====
    async function init(){
      const dict = await loadDict(LOCALE);
      try { applyI18n(dict); } catch(e){ console.warn('i18n apply failed', e); }

      console.log('LOCALE detected =', LOCALE, 'path =', location.pathname);
      console.log('Loaded dict keys:', Object.keys(window._i18nDict||{}));

      renderPunctGuide();   // <— key change for HTML rendering

      refreshGates();
      showQuota();
      updateTrialBanner();
    }
    init();

    // Periodic UI updates
    setInterval(()=>{ showQuota(); updateTrialBanner(); }, 10*60*1000);
  </script>
    <script>
/* === EZ PATCH: btnCorrect override (no surgery needed) === */
(function(){
  const LOCALE = (window.LOCALE) || document.documentElement.lang || 'en';

  function stripTags(html=""){ const d=document.createElement('div'); d.innerHTML=html; return d.textContent || d.innerText || ''; }
  function wcOf(text){ return (stripTags(text).match(/\b[\w’'-]+\b/g)||[]).length; }
  function wordBand(level){
    if(level==='B2') return {min:140, max:190};
    if(level==='C2') return {min:240, max:280};
    return {min:220, max:260}; // C1
  }
  function ensureKPI(){
    const host = document.querySelector('#corrector .kpi');
    if (host) return host;
    const k = document.createElement('div'); k.className = 'kpi';
    // minimal style if your CSS doesn't have .kpi defined
    k.style.display='flex'; k.style.flexWrap='wrap'; k.style.gap='8px'; k.style.margin='8px 0 10px';
    document.getElementById('corrector').prepend(k);
    return k;
  }
  function pill(txt, ok=true){
    const s = document.createElement('span');
    s.textContent = txt;
    s.style.display='inline-block'; s.style.padding='2px 8px'; s.style.borderRadius='999px';
    s.style.border='1px solid ' + (ok ? '#34d399' : '#f59e0b');
    s.style.background = ok ? '#ecfdf5' : '#fff7ed';
    s.style.fontSize='12px';
    return s;
  }
  function showWordcountBadge(text, level){
    const kpi = ensureKPI();
    // remove previous wc pill
    kpi.querySelectorAll('[data-wc]').forEach(n=>n.remove());
    const {min,max} = wordBand(level);
    const wc = wcOf(text);
    const ok = wc>=min && wc<=max;
    const p = pill(`Words: ${wc} (${min}–${max}${ok?' ✓': (wc<min?' ↓':' ↑')})`, ok);
    p.setAttribute('data-wc','1');
    kpi.prepend(p);
  }
  function safeUpdateSentenceAnalysis(text){
    try{
      if (typeof updateSentenceAnalysis === 'function') { updateSentenceAnalysis(text); return; }
      if (window.EC_Sentences && typeof window.EC_Sentences.analyzeToHTML === 'function') {
        const box=document.getElementById('sentenceAnalysis');
        if (box) box.innerHTML = window.EC_Sentences.analyzeToHTML(text, { locale: LOCALE }) || '';
      }
    }catch(_){}
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }

  // Minimal renderer for structured JSON (if/when backend sends it)
  function renderCorrection(data, level){
    const out = document.getElementById('essayOut');
    const t = data?.improved_text || '';
    // Tiny rubric readout (keep it compact)
    let top = '';
    if (data?.rubric){
      const r = data.rubric;
      const tile = (label, key)=> {
        const sc = (r[key]?.score ?? 0) + '/5';
        return `<div style="border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;min-width:140px">
                  <div style="font-weight:600;font-size:13px">${label}</div>
                  <div style="font-weight:700">${sc}</div>
                </div>`;
      };
      top += `<div class="kpi" style="display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px">
                ${tile('Content','content')}
                ${tile('Communicative','communicative_achievement')}
                ${tile('Organisation','organisation')}
                ${tile('Language','language')}
              </div>`;
    }
    // Register flags
    const reg = data?.checks?.register;
    const regHtml = (reg && Array.isArray(reg.violations) && reg.violations.length)
      ? `<div style="margin:6px 0">
           <div style="font-weight:600">Register: possible issues</div>
           <ul style="margin:4px 0 0 18px">${reg.violations.map(v=>`<li>${escapeHtml(v)}</li>`).join('')}</ul>
         </div>` : '';

    out.innerHTML = `${top}${regHtml}
      <h4 style="margin:12px 0 6px">${LOCALE==='es'?'Versión mejorada':'Improved version'}</h4>
      <div class="preview">${t}</div>`;

    // badges + analysis
    showWordcountBadge(t, level);
    safeUpdateSentenceAnalysis(stripTags(t));
  }

  function bind(){
    const btn = document.getElementById('btnCorrect');
    if (!btn) return;
    btn.addEventListener('click', async function(e){
      // Stop the old document-level handler from also firing
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

      const essayIn = document.getElementById('essayIn');
      const essayOut = document.getElementById('essayOut');
      const lvl = (document.getElementById('levelSelect')?.value || 'C1');
      const src = (essayIn?.value||'').trim();

      if(!src){ if(essayOut) essayOut.innerHTML=''; safeUpdateSentenceAnalysis(''); return; }
      if(essayOut) essayOut.innerHTML = LOCALE==='es' ? 'Procesando…' : 'Processing…';

      try{
        let data = null;
        if (typeof window.runCorrection === 'function') {
          data = await window.runCorrection(src);
        } else {
          // Fallback call if runCorrection is absent (keeps your app working)
          const opts = {
            formal: document.getElementById('tgFormal')?.checked !== false,
            coachNotes: document.getElementById('tgCoachNotes')?.checked !== false,
            rubric: document.getElementById('tgRubric')?.checked !== false,
            level: lvl, type: (document.getElementById('typeSelect')?.value || 'essay'),
            locale: LOCALE
          };
          const res = await fetch((window.EC_CONFIG?.API_BASE||'') + '/correct', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: src, options: opts })
          });
          if(!res.ok) throw new Error('Correction failed');
          data = await res.json();
        }

        // Case A: legacy string HTML
        if (typeof data === 'string' || typeof data?.output === 'string') {
          const html = (typeof data === 'string') ? data : data.output;
          essayOut.innerHTML = html;
          showWordcountBadge(html, lvl);
          safeUpdateSentenceAnalysis(stripTags(html));
        }
        // Case B: structured JSON
        else if (data && data.improved_text) {
          renderCorrection(data, lvl);
        }
        // Unknown
        else {
          essayOut.innerHTML = `<div class="hint">${LOCALE==='es'?'Respuesta inesperada del servidor.':'Unexpected server response.'}</div>`;
        }

        // Update quota UI if present
        try{
          window.QUOTA = window.QUOTA || { used:0, cap:(window.EC_CONFIG?.QUOTA_CAP||20) };
          window.QUOTA.used = Math.min((window.QUOTA.used||0)+1, (window.QUOTA.cap||20));
          if (typeof showQuota === 'function') showQuota();
        }catch(_){}
      }catch(err){
        essayOut.innerHTML = `<div class="hint">${escapeHtml(err.message||'Error')}</div>`;
      }
    }, { passive:false });
  }

  // run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>

</body>
</html>
